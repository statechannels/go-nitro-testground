name: Go

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v3
        with:
          go-version: "^1.18.0"
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3.1.0
        with:
          # Optional: version of golangci-lint to use in form of v1.2 or v1.2.3 or `latest` to use the latest version
          version: v1.45.2
      
      - name: Run staticcheck # see: staticcheck.io
        uses: dominikh/staticcheck-action@v1.2.0
        with:
          version: "2022.1.2"
          install-go: false
          min-go-version: 1.18

      - name: Build
        run: go build -v ./...

      - name: Tidy
        run: go mod tidy

      - name: check git tree is clean
        # This will fail the job if any previous step (re)generated a file
        # that doesn't match what you checked in (or forgot to check in)
        run: git diff --exit-code

  
      - name: Checkout testground
        uses: actions/checkout@v3
        with:
            repository: statechannels/testground
            path: ./testground
      
      - name:  restore cache
        uses: actions/cache@v3
        id: cache
        with:
          path:  ../testground
          key: ${{ runner.os }}-${{ hashFiles('**/go.sum') }}
    
      - name: Build testground
        working-directory: ./testground
        if: steps.cache.outputs.cache-hit != 'true'
        run: make install

      - name: Import test to testground
        run: testground plan import --from  ../go-nitro-testground

      - name: Start testground
        run: testground daemon &
       
      - name: Run testground test
        run:  testground run s -p=go-nitro-testground -t=virtual-payment -b=exec:go -r=local:exec -tp=numOfHubs=1 -i=3 -tp=paymentTestDuration=2 -tp=concurrentPaymentJobs=1

      # - name: Notify slack fail
      #   if: ${{ failure() && github.ref == 'refs/heads/main'}}
      #   env:
      #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_NOTIFICATIONS_BOT_TOKEN }}
      #   uses: voxmedia/github-action-slack-notify-build@v1
      #   with:
      #     channel_id: C03G4AUGA7M
      #     status: FAILED
      #     color: danger